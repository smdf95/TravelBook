{% extends "travel/base.html" %}
{% block content %}
{% load static %}

<!-- Trip Details -->

<div class="content-section">


    <!-- Picture, Title, and Travellers -->

    <div class="d-flex">
        <div class="p-2">
            {% if trip.image %}
                <img style="border-radius: 50%; object-fit: cover; object-position: center center;" class="rounded-circle account-img" src="{{ trip.image.url }}" width="200" height="200" alt="{{ trip.title }} Profile Picture">
            {% else %}
                <img style="border-radius: 50%; object-fit: cover; object-position: center center;" class="rounded-circle account-img" src="{% static 'trip_pics/default.png' %}" width="200" height="200" alt="{{ trip.title }} Profile Picture">
            {% endif %}
            
        </div>
        <div class="p-2 align-self-center d-flex">
            <h1>{{ trip.title }}</h1>
        </div>
        <div class="p-2 align-self-center d-flex">
            
            <div class="dropdown">
                <span class="material-symbols-outlined" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                    more_horiz
                </span>
                <ul class="dropdown-menu p-0" aria-labelledby="dropdownMenuButton1">
                    {% if request.user in trip.travellers.all %}
                        <li class="p-2 pointer hover" data-url="{% url 'trip-update' trip.id %}" onclick="redirectToUrl(this)">Update</li>
                        <li class="p-2 pointer hover" data-url="{% url 'trip-delete' trip.id %}" onclick="redirectToUrl(this)">Delete</li>
                    {% endif %}
                    <li class="p-2 pointer hover" data-url="{% url 'leave-trip' trip.id %}" onclick="redirectToUrl(this)">Leave</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Travellers and Viewers -->
    
    <div class="d-flex mt-3 mb-3 d-flex align-items-center">
        <div class="p-2">
            <h4 class="m-0">Travellers:</h4>
        </div>
        <div class="p-2">

            {% for traveller in trip.travellers.all %}
                    {% if traveller.profile.image %}
                        <img style="border-radius: 50%; object-fit: cover; object-position: center center;" class="rounded-circle account-img" src="{{ traveller.profile.image }}" width="40" height="40" alt="{{ traveller.first_name }} Profile Picture">
                    {% else %}
                        <img style="border-radius: 50%; object-fit: cover; object-position: center center;" class="rounded-circle account-img" src="{% static 'profile_pics/default.png' %}" width="40" height="40" alt="{{ traveller.first_name }} Profile Picture">
                    {% endif %}
                {% endfor %}
        </div>
        <div class="p-2 ms-auto">
            <h4 class="m-0">Viewers:</h4>
        </div>
        <div class="p-2">

            {% for viewer in trip.viewers.all %}
                    {% if viewer.profile.image %}
                        <img style="border-radius: 50%; object-fit: cover; object-position: center center;" class="rounded-circle account-img" src="{{ viewer.profile.image }}" width="40" height="40" alt="{{ viewer.first_name }} Profile Picture">
                    {% else %}
                        <img style="border-radius: 50%; object-fit: cover; object-position: center center;" class="rounded-circle account-img" src="{% static 'profile_pics/default.png' %}" width="40" height="40" alt="{{ viewer.first_name }} Profile Picture">
                    {% endif %}
                {% endfor %}
        </div>
    </div>




    <!-- Trip Settings -->
    {% if request.user in trip.travellers.all %}


        <div class="p-2 d-flex align-items-center">
            <span class="material-symbols-outlined me-2 pointer" data-url="{% url 'add-traveller' trip.id %}" onclick="redirectToUrl(this)">
                person_add
            </span>
            <div class="pointer" data-url="{% url 'add-traveller' trip.id %}" onclick="redirectToUrl(this)">
                Add Traveller
            </div>
        </div>
        <div class="p-2 d-flex align-items-center">
            <span class="material-symbols-outlined me-2 pointer" data-url="{% url 'add-viewer' trip.id %}" onclick="redirectToUrl(this)">
                share
            </span>
            <div class="pointer" data-url="{% url 'add-viewer' trip.id %}" onclick="redirectToUrl(this)">
                Share Trip
            </div>
        </div>
    {% endif %}
</div>


<!-- Posts List -->

{% if posts %}
    {% for post in posts %}

        <div class="card mt-2 mb-2">
            <div class="d-flex">

                <!-- Poster Profile Picture, Name, and Timestamp -->

                <div class="p-2">
                    {% if post.created_by.profile.image %}
                        <img style="border-radius: 50%; object-fit: cover; object-position: center center;" class="rounded-circle account-img" src="{{ post.created_by.profile.image }}" width="50" height="50" alt="{{ post.created_by.first_name }} Profile Picture">
                    {% else %}
                        <img style="border-radius: 50%; object-fit: cover; object-position: center center;" class="rounded-circle account-img" src="{% static 'profile_pics/default.png' %}" width="50" height="50" alt="{{ post.created_by.first_name }} Profile Picture">
                    {% endif %}
                </div>
                <div class="p-2">
                    <div class="fw-bold">{{ post.created_by.first_name }} {{ post.created_by.last_name }}</div>
                    <div class="text-muted"><small>
                        {% if post.time_diff %}
                            {{ post.time_diff }}
                        {% else %}
                            {{ post.created_on }}
                        {% endif %}
                    </small></div>
                </div>

                <!-- Location  -->

                <div class="ms-auto p-2 d-flex">
                    <span class="material-symbols-outlined">
                    location_on
                    </span>
                    {% if post.location %}
                        <p><a href="{% url 'maps' post.location %}">{{ post.location }}</a></p>
                    {% else %}
                        <p>No location provided</p>
                    {% endif %}
                </div>
            </div>

            <!-- Post Content and Images -->

            <div class="col d-flex p-3">
                <div class="justify-content-start">
                    <p>{{ post.content }}</p>
                </div>
            </div>
            <div class="justify-content-center ms-auto me-auto">
                {% if post.image %}
                    <img style="object-fit: cover; object-position: center center;" src="{{ post.image }}" class="post_image">
                {% endif %}
            </div>
            
            <!-- Likes and comments counter -->

            <div class="d-flex">
                <div class="d-flex me-auto me-5"
                >
                    {% include 'partials/post_likes_trip_counter.html' %}
                </div>
        
                {% if post.comments.count > 0 %}
                    <div class="d-flex align-items-center ms-auto me-5">
                        <p class="counter mb-1">{{ post.comments_num }} {% if post.comments.count == 1 %} Comment {% else %} Comments {% endif %}</p>
                    </div>
                {% endif %}
            </div>

            <!-- Like and comment buttons -->

            <div class="d-flex justify-content-around">
                <div class="ms-5 ps-3 p-2 d-flex pointer" style="font-size: 14px;" 
                hx-post="{% url 'post-like-trip' post.id %}"
                hx-trigger="click"
                hx-target=".body"
                hx-swap="outerHTML">
                    {% include 'partials/post_likes_area.html' %}
                </div>

                <div class="ml-auto p-2 d-flex pointer" data-url="{% url 'post-detail' pk=post.id %}" onclick="redirectToUrl(this)">
                    <span class="material-symbols-outlined me-2">
                        comment
                    </span>
                    <p>Comment</p>
                </div>


                <!-- Delete button if post was created by user -->

                {% if post.created_by == user %}

                    <!-- Delete button changes style on hover -->

                    <div class="delete_div p-2 d-flex pointer" 
                        onmouseover="changeIcon(this, 'delete')"
                        onmouseout="changeIcon(this, 'delete_outline')">
                        <span class="material-icons pointer me-1" 
                            data-url="{% url 'post-delete' post.id %}" 
                            onclick="redirectToUrl(this)">
                            delete_outline
                        </span>
                        <p>Delete</p>
                    </div>
                {% endif %}

            </div>
        </div>

        
    {% endfor %}
{% endif %}
        <div class="like_list post_like_list d-none position-fixed top-50 start-50 translate-middle">

        </div>

<!-- Add button for adding new Post -->
{% if request.user in trip.travellers.all %}

    <div class="add_container">
        <span class="material-symbols-outlined add" data-url="{% url 'post-create' pk=trip.id %}" onclick="redirectToUrl(this)">
            add_circle
        </span>
    </div>
{% endif %}
{% endblock content %}
